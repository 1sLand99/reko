#region License
/* 
 * Copyright (C) 1999-2025 John Källén.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; see the file COPYING.  If not, write to
 * the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
 */
#endregion

using Reko.Core;
using Reko.Core.Loading;
using System.Collections.Generic;
using static Reko.ImageLoaders.Elf.Relocators.CSkyRelocator;

namespace Reko.ImageLoaders.Elf.Relocators;

public class BeyondRelocator : ElfRelocator32
{
    public BeyondRelocator(ElfLoader32 loader, SortedList<Address, ImageSymbol> imageSymbols) 
        : base(loader, imageSymbols)
    {
    }

    public override (Address?, ElfSymbol?) RelocateEntry(RelocationContext ctx, ElfRelocation rela, ElfSymbol symbol)
    {
        var addr = ctx.CreateAddress(ctx.P);
        var rt = (BaRt) (rela.Info & 0xFFFF);
        switch (rt)
        {
        //case Aarch64Rt.R_AARCH64_RELATIVE:  // B + A
        //    ctx.WriteUInt64(addr, ctx.B + ctx.A);
        //    return (addr, null);
        //case Aarch64Rt.R_AARCH64_JUMP_SLOT: // A + S
        //case Aarch64Rt.R_AARCH64_GLOB_DAT:  // A + S
        //    ctx.WriteUInt64(addr, ctx.S + ctx.A);
        //    return (addr, null);
        default:
            ctx.Warn(addr, $"Unimplemented Beyond BA2x relocation type {rt}.");
            return (addr, null);
        }
    }

    public override string? RelocationTypeToString(uint type)
    {
        return ((BaRt) type).ToString();
    }
}

public enum BaRt
{
    R_BA_NONE = 0,
    R_BA_32 = 1,
    R_BA_16 = 2,
    R_BA_8 = 3,
    R_BA_CONST = 4,
    R_BA_CONST_SPLIT = 5,
    R_BA_CONSTH = 6,
    R_BA_CONSTH_S = 7,
    R_BA_JUMPTARG = 8,
    R_BA_GNU_VTENTRY = 9,
    R_BA_GNU_VTINHERIT = 10,
    R_BA_GPREL16 = 11,
    R_BA_GPREL16_SPLIT = 12,
    R_BA_8_PCREL_LSB = 13,
    R_BA_16_PCREL_LSB = 14,
    R_BA_24_PCREL_LSB = 15,
    R_BA_32_PCREL_LSB = 16,
    R_BA_32_DIFF = 17,
    R_BA_16_DIFF = 18,
    R_BA_8_DIFF = 19,
    R_BA_2 = 20,
    R_BA_8_S1 = 21,
    R_BA_8_S2 = 22,
    R_BA_8_S3 = 23,
    R_BA_16_S1 = 24,
    R_BA_16_S2 = 25,
    R_BA_16_S3 = 26,
    R_BA_32_S1 = 27,
    R_BA_32_S2 = 28,
    R_BA_32_S3 = 29,
    R_BA_10_PCREL_LSB = 30,
    R_BA_12_PCREL_LSB = 31,
    R_BA_18_PCREL_LSB = 32,
    R_BA_28_PCREL_LSB = 33,
    R_BA_GPREL8_S0 = 34,
    R_BA_GPREL8_S1 = 35,
    R_BA_GPREL8_S2 = 36,
    R_BA_GPREL8_S3 = 37,
    R_BA_GPREL16_S0 = 38,
    R_BA_GPREL16_S1 = 39,
    R_BA_GPREL16_S2 = 40,
    R_BA_GPREL16_S3 = 41,
    R_BA_GPREL32_S0 = 42,
    R_BA_GPREL32_S1 = 43,
    R_BA_GPREL32_S2 = 44,
    R_BA_GPREL32_S3 = 45,
    R_BA_32_LSB = 46,
    R_BA_16_LSB = 47,
    R_BA_8_LSB = 48,
    R_BA_12_PCREL_1 = 49,
    R_BA_ALIGN = 50,
    R_BA_14_PCREL_S2 = 51,
    R_BA_HI32_S = 52,
    R_BA_HI31_S = 53,
    R_BA_HI30_S = 54,
    R_BA_HI29_S = 55,
    R_BA_LO32_S = 56,
    R_BA_LO31_S = 57,
    R_BA_LO30_S = 58,
    R_BA_LO29_S = 59,
    R_BA_HI32 = 60,
    R_BA_HI31 = 61,
    R_BA_HI30 = 62,
    R_BA_HI29 = 63,
    R_BA_LO32 = 64,
    R_BA_LO31 = 65,
    R_BA_LO30 = 66,
    R_BA_LO29 = 67,
    R_BA_16_INSN = 68,
    R_BA_ORG = 69,
    R_BA_32_DIFF_LSB = 70,
    R_BA_16_DIFF_LSB = 71,
    R_BA_8_DIFF_LSB = 72,
    R_BA_GOTOFF16 = 73,
    R_BA_GOTOFF16_SPLIT = 74,
    R_BA_GOTOFF8_S2 = 75,
    R_BA_GOTOFF16_S2 = 76,
    R_BA_GOTOFF32_S2 = 77,
    R_BA_8_PLT = 78,
    R_BA_16_PLT = 79,
    R_BA_24_PLT = 80,
    R_BA_32_PLT = 81,
    R_BA_10_PLT = 82,
    R_BA_12_PLT = 83,
    R_BA_18_PLT = 84,
    R_BA_28_PLT = 85,
    R_BA_12_PLT_1 = 86,
    R_BA_14_PLT_S2 = 87,
    R_BA_28_PLT_S2 = 88,
    R_BA_GOT_PLT = 89,
    R_BA_32_RELATIVE = 90,
    R_BA_COPY = 91,
    R_BA_GOTOFF8_S0 = 92,
    R_BA_GOTOFF16_S0 = 93,
    R_BA_GOTOFF32_S0 = 94,
    R_BA_GP_MINUS_32 = 95,
    R_BA_GP_MINUS_16 = 96,
    R_BA_GP_MINUS_8 = 97,
    R_BA_GP_MINUS_HI = 98,
    R_BA_GP_MINUS_LO = 99,
    R_BA_32_PCREL_S2 = 100,
    R_BA_32_PCREL_S1 = 101,
    R_BA_16_PCREL_S2 = 102,
    R_BA_16_PCREL_S1 = 103,
    R_BA_16_PCREL_S0 = 104,
    R_BA_8_PCREL_S2 = 105,
    R_BA_8_PCREL_S1 = 106,
    R_BA_GOTPC8_S0 = 107,
    R_BA_GOTPC16_S0 = 108,
    R_BA_GOTPC32_S0 = 109,
    R_BA_GOTPC8_S2 = 110,
    R_BA_GOTPC16_S2 = 111,
    R_BA_GOTPC32_S2 = 112,
    R_BA_GOTPC32_FULL = 113,
    R_BA_32_PCREL_S0 = 114,
    R_BA_8_PCREL_S0 = 115,
    R_BA_GOTOFF8_S1 = 116,
    R_BA_GOTOFF16_S1 = 117,
    R_BA_GOTOFF32_S1 = 118,
    R_BA_GOTPC8_S1 = 119,
    R_BA_GOTPC16_S1 = 120,
    R_BA_GOTPC32_S1 = 121,
    R_BA_TLS_GD_8_S0 = 122,
    R_BA_TLS_GD_16_S0 = 123,
    R_BA_TLS_GD_32_S0 = 124,
    R_BA_TLS_LD_8_S0 = 125,
    R_BA_TLS_LD_16_S0 = 126,
    R_BA_TLS_LD_32_S0 = 127,
    R_BA_TLS_LDO_8_S0 = 128,
    R_BA_TLS_LDO_16_S0 = 129,
    R_BA_TLS_LDO_32_S0 = 130,
    R_BA_TLS_LDO_8_S1 = 131,
    R_BA_TLS_LDO_16_S1 = 132,
    R_BA_TLS_LDO_32_S1 = 133,
    R_BA_TLS_LDO_8_S2 = 134,
    R_BA_TLS_LDO_16_S2 = 135,
    R_BA_TLS_LDO_32_S2 = 136,
    R_BA_TLS_IE_GOT_8_S0 = 137,
    R_BA_TLS_IE_GOT_16_S0 = 138,
    R_BA_TLS_IE_GOT_32_S0 = 139,
    R_BA_TLS_IE_GOT_8_S1 = 140,
    R_BA_TLS_IE_GOT_16_S1 = 141,
    R_BA_TLS_IE_GOT_32_S1 = 142,
    R_BA_TLS_IE_GOT_8_S2 = 143,
    R_BA_TLS_IE_GOT_16_S2 = 144,
    R_BA_TLS_IE_GOT_32_S2 = 145,
    R_BA_TLS_IE_ABS_8_S0 = 146,
    R_BA_TLS_IE_ABS_16_S0 = 147,
    R_BA_TLS_IE_ABS_32_S0 = 148,
    R_BA_TLS_IE_ABS_8_S1 = 149,
    R_BA_TLS_IE_ABS_16_S1 = 150,
    R_BA_TLS_IE_ABS_32_S1 = 151,
    R_BA_TLS_IE_ABS_8_S2 = 152,
    R_BA_TLS_IE_ABS_16_S2 = 153,
    R_BA_TLS_IE_ABS_32_S2 = 154,
    R_BA_TLS_LE_8_S0 = 155,
    R_BA_TLS_LE_16_S0 = 156,
    R_BA_TLS_LE_32_S0 = 157,
    R_BA_TLS_LE_8_S1 = 158,
    R_BA_TLS_LE_16_S1 = 159,
    R_BA_TLS_LE_32_S1 = 160,
    R_BA_TLS_LE_8_S2 = 161,
    R_BA_TLS_LE_16_S2 = 162,
    R_BA_TLS_LE_32_S2 = 163,
    R_BA_TLS_MOD_32 = 164,
    R_BA_TLS_OFF_32 = 165,
    R_BA_TLS_TPOFF_32 = 166,
    R_BA_8_PCREL = 167,
    R_BA_16_PCREL = 168,
    R_BA_32_PCREL = 169,
    R_BA_SLEB128_DIFF = 170,
    R_BA_ULEB128_DIFF = 171,
    R_BA_DIFF_ADD = 172,
    R_BA_TLS_LDO_16_SPLIT = 173,
    R_BA_TLS_IE_GOT_16_SPLIT = 174,
    R_BA_TLS_IE_ABS_LO_16_SPLIT = 175,
    R_BA_TLS_LE_16_SPLIT = 176,
    R_BA_TLS_GD_16 = 177,
    R_BA_TLS_LD_16 = 178,
    R_BA_TLS_LDO_16 = 179,
    R_BA_TLS_IE_GOT_16 = 180,
    R_BA_TLS_IE_ABS_LO_16 = 181,
    R_BA_TLS_IE_ABS_HI_16 = 182,
    R_BA_TLS_LE_16 = 183,
    R_BA_FDESC_PLT = 184,
    R_BA_GOT_FDESC8_S0 = 185,
    R_BA_GOT_FDESC16_S0 = 186,
    R_BA_GOT_FDESC32_S0 = 187,
    R_BA_GOT_FDESC8_S1 = 188,
    R_BA_GOT_FDESC16_S1 = 189,
    R_BA_GOT_FDESC32_S1 = 190,
    R_BA_GOT_FDESC8_S2 = 191,
    R_BA_GOT_FDESC16_S2 = 192,
    R_BA_GOT_FDESC32_S2 = 193,
    R_BA_32_FDESC = 194,
    R_BA_GOT_FDESC16 = 195,
    R_BA_GOT_FDESC16_SPLIT = 196,
    R_BA_32_RELATIVE_FDESC = 197,
    R_BA_GOT_FDESC_VAL8_S0 = 198,
    R_BA_GOT_FDESC_VAL16_S0 = 199,
    R_BA_GOT_FDESC_VAL32_S0 = 200,
    R_BA_GOT_FDESC_VAL8_S1 = 201,
    R_BA_GOT_FDESC_VAL16_S1 = 202,
    R_BA_GOT_FDESC_VAL32_S1 = 203,
    R_BA_GOT_FDESC_VAL8_S2 = 204,
    R_BA_GOT_FDESC_VAL16_S2 = 205,
    R_BA_GOT_FDESC_VAL32_S2 = 206,
    R_BA_GOT_FDESC_VAL16 = 207,
    R_BA_GOT_FDESC_VAL16_SPLIT = 208,
    R_BA_32_FDESC_VAL = 209,
    R_BA_32_RELATIVE_FDESC_VAL = 210,
}

public enum Ba64Rt
{
    R_BA64_NONE = 0,
    R_BA64_8 = 1,
    R_BA64_16 = 2,
    R_BA64_32 = 3,
    R_BA64_64 = 4,
    R_BA64_GOT_PLT = 5,
    R_BA64_64_RELATIVE = 6,
    R_BA64_COPY = 7,
    R_BA64_TLS_MOD_64 = 8,
    R_BA64_TLS_OFF_64 = 9,
    R_BA64_TLS_TPOFF_64 = 10,
    R_BA64_FDESC_PLT = 11,
    R_BA64_64_FDESC = 12,
    R_BA64_64_RELATIVE_FDESC = 13,
    R_BA64_64_FDESC_VAL = 14,
    R_BA64_64_RELATIVE_FDESC_VAL = 15,
    R_BA64_8_PCREL = 16,
    R_BA64_16_PCREL = 17,
    R_BA64_32_PCREL = 18,
    R_BA64_64_PCREL = 19,
    R_BA64_8_S0 = 20,
    R_BA64_8_S1 = 21,
    R_BA64_8_S2 = 22,
    R_BA64_8_S3 = 23,
    R_BA64_16_S0 = 24,
    R_BA64_16_S1 = 25,
    R_BA64_16_S2 = 26,
    R_BA64_16_S3 = 27,
    R_BA64_32_S0 = 28,
    R_BA64_32_S1 = 29,
    R_BA64_32_S2 = 30,
    R_BA64_32_S3 = 31,
    R_BA64_8_HIW = 32,
    R_BA64_16_HIW = 33,
    R_BA64_32_HIW = 34,
    R_BA64_8_LOW_S0 = 35,
    R_BA64_8_LOW_S1 = 36,
    R_BA64_8_LOW_S2 = 37,
    R_BA64_8_LOW_S3 = 38,
    R_BA64_16_LOW_S0 = 39,
    R_BA64_16_LOW_S1 = 40,
    R_BA64_16_LOW_S2 = 41,
    R_BA64_16_LOW_S3 = 42,
    R_BA64_32_LOW_S0 = 43,
    R_BA64_32_LOW_S1 = 44,
    R_BA64_32_LOW_S2 = 45,
    R_BA64_32_LOW_S3 = 46,
    R_BA64_8_PCREL_S0 = 47,
    R_BA64_8_PCREL_S1 = 48,
    R_BA64_8_PCREL_S2 = 49,
    R_BA64_8_PCREL_S3 = 50,
    R_BA64_16_PCREL_S0 = 51,
    R_BA64_16_PCREL_S1 = 52,
    R_BA64_16_PCREL_S2 = 53,
    R_BA64_16_PCREL_S3 = 54,
    R_BA64_32_PCREL_S0 = 55,
    R_BA64_32_PCREL_S1 = 56,
    R_BA64_32_PCREL_S2 = 57,
    R_BA64_32_PCREL_S3 = 58,
    R_BA64_GPREL8_S0 = 59,
    R_BA64_GPREL8_S1 = 60,
    R_BA64_GPREL8_S2 = 61,
    R_BA64_GPREL8_S3 = 62,
    R_BA64_GPREL16_S0 = 63,
    R_BA64_GPREL16_S1 = 64,
    R_BA64_GPREL16_S2 = 65,
    R_BA64_GPREL16_S3 = 66,
    R_BA64_GPREL32_S0 = 67,
    R_BA64_GPREL32_S1 = 68,
    R_BA64_GPREL32_S2 = 69,
    R_BA64_GPREL32_S3 = 70,
    R_BA64_GOTOFF8_S0 = 71,
    R_BA64_GOTOFF8_S1 = 72,
    R_BA64_GOTOFF8_S2 = 73,
    R_BA64_GOTOFF8_S3 = 74,
    R_BA64_GOTOFF16_S0 = 75,
    R_BA64_GOTOFF16_S1 = 76,
    R_BA64_GOTOFF16_S2 = 77,
    R_BA64_GOTOFF16_S3 = 78,
    R_BA64_GOTOFF32_S0 = 79,
    R_BA64_GOTOFF32_S1 = 80,
    R_BA64_GOTOFF32_S2 = 81,
    R_BA64_GOTOFF32_S3 = 82,
    R_BA64_GOTPC8_S0 = 83,
    R_BA64_GOTPC8_S1 = 84,
    R_BA64_GOTPC8_S2 = 85,
    R_BA64_GOTPC8_S3 = 86,
    R_BA64_GOTPC16_S0 = 87,
    R_BA64_GOTPC16_S1 = 88,
    R_BA64_GOTPC16_S2 = 89,
    R_BA64_GOTPC16_S3 = 90,
    R_BA64_GOTPC32_S0 = 91,
    R_BA64_GOTPC32_S1 = 92,
    R_BA64_GOTPC32_S2 = 93,
    R_BA64_GOTPC32_S3 = 94,
    R_BA64_TLS_GD_8_S0 = 95,
    R_BA64_TLS_GD_16_S0 = 96,
    R_BA64_TLS_GD_32_S0 = 97,
    R_BA64_TLS_LD_8_S0 = 98,
    R_BA64_TLS_LD_16_S0 = 99,
    R_BA64_TLS_LD_32_S0 = 100,
    R_BA64_TLS_LDO_8_S0 = 101,
    R_BA64_TLS_LDO_8_S1 = 102,
    R_BA64_TLS_LDO_8_S2 = 103,
    R_BA64_TLS_LDO_8_S3 = 104,
    R_BA64_TLS_LDO_16_S0 = 105,
    R_BA64_TLS_LDO_16_S1 = 106,
    R_BA64_TLS_LDO_16_S2 = 107,
    R_BA64_TLS_LDO_16_S3 = 108,
    R_BA64_TLS_LDO_32_S0 = 109,
    R_BA64_TLS_LDO_32_S1 = 110,
    R_BA64_TLS_LDO_32_S2 = 111,
    R_BA64_TLS_LDO_32_S3 = 112,
    R_BA64_TLS_IE_GOT_8_S0 = 113,
    R_BA64_TLS_IE_GOT_8_S1 = 114,
    R_BA64_TLS_IE_GOT_8_S2 = 115,
    R_BA64_TLS_IE_GOT_8_S3 = 116,
    R_BA64_TLS_IE_GOT_16_S0 = 117,
    R_BA64_TLS_IE_GOT_16_S1 = 118,
    R_BA64_TLS_IE_GOT_16_S2 = 119,
    R_BA64_TLS_IE_GOT_16_S3 = 120,
    R_BA64_TLS_IE_GOT_32_S0 = 121,
    R_BA64_TLS_IE_GOT_32_S1 = 122,
    R_BA64_TLS_IE_GOT_32_S2 = 123,
    R_BA64_TLS_IE_GOT_32_S3 = 124,
    R_BA64_TLS_IE_ABS_8_S0 = 125,
    R_BA64_TLS_IE_ABS_8_S1 = 126,
    R_BA64_TLS_IE_ABS_8_S2 = 127,
    R_BA64_TLS_IE_ABS_8_S3 = 128,
    R_BA64_TLS_IE_ABS_16_S0 = 129,
    R_BA64_TLS_IE_ABS_16_S1 = 130,
    R_BA64_TLS_IE_ABS_16_S2 = 131,
    R_BA64_TLS_IE_ABS_16_S3 = 132,
    R_BA64_TLS_IE_ABS_32_S0 = 133,
    R_BA64_TLS_IE_ABS_32_S1 = 134,
    R_BA64_TLS_IE_ABS_32_S2 = 135,
    R_BA64_TLS_IE_ABS_32_S3 = 136,
    R_BA64_TLS_LE_8_S0 = 137,
    R_BA64_TLS_LE_8_S1 = 138,
    R_BA64_TLS_LE_8_S2 = 139,
    R_BA64_TLS_LE_8_S3 = 140,
    R_BA64_TLS_LE_16_S0 = 141,
    R_BA64_TLS_LE_16_S1 = 142,
    R_BA64_TLS_LE_16_S2 = 143,
    R_BA64_TLS_LE_16_S3 = 144,
    R_BA64_TLS_LE_32_S0 = 145,
    R_BA64_TLS_LE_32_S1 = 146,
    R_BA64_TLS_LE_32_S2 = 147,
    R_BA64_TLS_LE_32_S3 = 148,
    R_BA64_GOT_FDESC8_S0 = 149,
    R_BA64_GOT_FDESC8_S1 = 150,
    R_BA64_GOT_FDESC8_S2 = 151,
    R_BA64_GOT_FDESC8_S3 = 152,
    R_BA64_GOT_FDESC16_S0 = 153,
    R_BA64_GOT_FDESC16_S1 = 154,
    R_BA64_GOT_FDESC16_S2 = 155,
    R_BA64_GOT_FDESC16_S3 = 156,
    R_BA64_GOT_FDESC32_S0 = 157,
    R_BA64_GOT_FDESC32_S1 = 158,
    R_BA64_GOT_FDESC32_S2 = 159,
    R_BA64_GOT_FDESC32_S3 = 160,
    R_BA64_GOT_FDESC_VAL8_S0 = 161,
    R_BA64_GOT_FDESC_VAL8_S1 = 162,
    R_BA64_GOT_FDESC_VAL8_S2 = 163,
    R_BA64_GOT_FDESC_VAL8_S3 = 164,
    R_BA64_GOT_FDESC_VAL16_S0 = 165,
    R_BA64_GOT_FDESC_VAL16_S1 = 166,
    R_BA64_GOT_FDESC_VAL16_S2 = 167,
    R_BA64_GOT_FDESC_VAL16_S3 = 168,
    R_BA64_GOT_FDESC_VAL32_S0 = 169,
    R_BA64_GOT_FDESC_VAL32_S1 = 170,
    R_BA64_GOT_FDESC_VAL32_S2 = 171,
    R_BA64_GOT_FDESC_VAL32_S3 = 172,
    R_BA64_GP_MINUS_8 = 173,
    R_BA64_GP_MINUS_16 = 174,
    R_BA64_GP_MINUS_32 = 175,
    R_BA64_8_DIFF_S0 = 176,
    R_BA64_16_DIFF_S0 = 177,
    R_BA64_32_DIFF_S0 = 178,
    R_BA64_GOTPC32_FULL = 179,
    R_BA64_8_PCREL_LSB = 180,
    R_BA64_10_PCREL_LSB = 181,
    R_BA64_12_PCREL_LSB = 182,
    R_BA64_12_PCREL_LSB1 = 183,
    R_BA64_16_PCREL_LSB = 184,
    R_BA64_18_PCREL_LSB = 185,
    R_BA64_24_PCREL_LSB = 186,
    R_BA64_28_PCREL_LSB = 187,
    R_BA64_32_PCREL_LSB = 188,
    R_BA64_8_PLT = 189,
    R_BA64_10_PLT = 190,
    R_BA64_12_PLT = 191,
    R_BA64_12_PLT_1 = 192,
    R_BA64_16_PLT = 193,
    R_BA64_18_PLT = 194,
    R_BA64_24_PLT = 195,
    R_BA64_28_PLT = 196,
    R_BA64_32_PLT = 197,
    R_BA64_ALIGN = 198,
    R_BA64_ORG = 199,
    R_BA64_8_DIFF = 200,
    R_BA64_16_DIFF = 201,
    R_BA64_32_DIFF = 202,
    R_BA64_64_DIFF = 203,
    R_BA64_8_DIFF_LSB = 204,
    R_BA64_16_DIFF_LSB = 205,
    R_BA64_32_DIFF_LSB = 206,
    R_BA64_DIFF_ADD = 207,
    R_BA64_SLEB128_DIFF = 208,
    R_BA64_ULEB128_DIFF = 209,
}